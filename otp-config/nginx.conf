events {
    worker_connections 1024;
}

http {
    upstream otp_backend {
        # Round-robin load balancing across 15 OTP instances
        server otp1:8080 max_fails=5 fail_timeout=10s;
        server otp2:8080 max_fails=5 fail_timeout=10s;
        server otp3:8080 max_fails=5 fail_timeout=10s;
        server otp4:8080 max_fails=5 fail_timeout=10s;
        server otp5:8080 max_fails=5 fail_timeout=10s;
        server otp6:8080 max_fails=5 fail_timeout=10s;
        server otp7:8080 max_fails=5 fail_timeout=10s;
        server otp8:8080 max_fails=5 fail_timeout=10s;
        server otp9:8080 max_fails=5 fail_timeout=10s;
        server otp10:8080 max_fails=5 fail_timeout=10s;
        server otp11:8080 max_fails=5 fail_timeout=10s;
        server otp12:8080 max_fails=5 fail_timeout=10s;
        server otp13:8080 max_fails=5 fail_timeout=10s;
        server otp14:8080 max_fails=5 fail_timeout=10s;
        server otp15:8080 max_fails=5 fail_timeout=10s;

        # Keep connections alive for better performance
        keepalive 32;
    }

    server {
        listen 8080;

        location / {
            proxy_pass http://otp_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Timeout settings for long isochrone computations (180m bands can take 30-60s)
            proxy_connect_timeout 10s;
            proxy_send_timeout 120s;
            proxy_read_timeout 480s;

            # Retry on failure (try next upstream)
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
    }
}
